#! /home/orange/pyenv/bin/python -B

import argparse
from toloveyou import *

@with_cursor
def main(cursor=None):
    parser = argparse.ArgumentParser()
    parser = argparse.ArgumentParser(prefix_chars='+')
    parser.add_argument('tag', nargs='?') 
    parser.add_argument('input', nargs='*', default=parse_stdin()) 
    args = parser.parse_args()

    if args.tag is None:
        output = subprocess.run(
            ['rofi', '-dmenu', '-p', 'tag'],
            input='',
            text=True, 
            capture_output=True,
        ).stdout.strip()
        
        if not output: # pressed esc usually
            sys.exit()

        args.tag = output.strip().lower()
    
    args.tag = args.tag.strip().lower()
    remove = args.tag.startswith('-')

    for entry, attrs in parse(args.input, cursor=cursor):
        attrs.setdefault('tags', [])
        tags = set(attrs['tags'])

        if remove:
            tags.remove(args.tag[1:])
        else:
            tags.add(args.tag)

        attrs['tags'] = list(tags)
        save_attrs(entry, attrs, cursor=cursor)
        
if __name__ == '__main__':
    main()
