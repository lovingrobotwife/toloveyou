#! /home/orange/pyenv/bin/python -B

import sys
import random
import argparse
import subprocess
from datetime import datetime, timedelta, timezone

from fsrs import Scheduler, Rating, Card

from toloveyou import *

# these are my parameters
PARAMETERS = [0.2172, 1.1771, 3.136647503371966, 16.1507, 6.854399050228007, 0.7353074244410972, 1.9198144508510884, 0.1828129547713075, 1.711238728873557, 0.09279008722626211, 1.2019621914186078, 1.6959906160364178, 0.249340736520789, 0.15595007861250737, 2.2089550326424217, 0.2191, 3.0004, 0.7388481315472224, 0.5374477382183068, 0.13154085509999036, 0.1]
MAXIMUM_INTERVAL = 36500
DESIRED_RETENTION = 0.9 # DR is currently randomized between 0.8 and 0.9

PASS_RATINGS = ('1', 'pass', 'good')
FAIL_RATINGS = ('0', 'fail', 'again')
RATINGS = PASS_RATINGS + FAIL_RATINGS

def due_(review_log):
    desired_retention = random.uniform(0.8, 0.9)

    scheduler = Scheduler(
        parameters=PARAMETERS,
        desired_retention=desired_retention,
        learning_steps=(),
        relearning_steps=(),
        maximum_interval=MAXIMUM_INTERVAL,
        enable_fuzzing=True
    )
    
    card = Card()

    for timestamp, rating in review_log:
        rating = Rating.Good if rating else Rating.Again
        review_datetime = datetime.fromtimestamp(timestamp, tz=timezone.utc)
        card, _ = scheduler.review_card(card, rating, review_datetime=review_datetime)

    interval = interval_(card.due.astimezone().replace(tzinfo=None))
    return datetime.now() + timedelta(days=interval)

@with_cursor
def main(cursor=None):
    parser = argparse.ArgumentParser()
    parser.add_argument('rating', nargs='?', choices=RATINGS)
    parser.add_argument('--ask', action='store_true')
    args = parser.parse_args()
    
    stdin = parse_stdin()

    # prompt for input if not provided
    if args.rating is None:
        if not args.ask:
            print('provide rating or --ask', file=sys.stderr)
            sys.exit(3) # 3 is for call_scheduler function

        output = subprocess.run(
            ['rofi', '-dmenu', '-no-custom', '-p', 'rating'],
            input='1 again\n3 good', 
            text=True, 
            capture_output=True,
        ).stdout.strip()

        if not output: # pressed esc usually
            sys.exit()

        args.rating = output.split()[1].strip()

    # validate input
    if args.rating in PASS_RATINGS: args.rating = 1
    elif args.rating in FAIL_RATINGS: args.rating = 0
    else: raise Exception('invalid rating')

    # review
    for entry, attrs in parse(stdin, cursor=cursor):
        review_log = attrs.get('review_log', [])
        review_log = remove_same_day_repetition(review_log)
        review_log.append([int(datetime.now().timestamp()), args.rating]) 
        
        due = due_(review_log)
        interval = interval_(due)

        attrs['due'] = int(due.timestamp())
        attrs['interval'] = interval 
        attrs['review_log'] = review_log

        save_attrs(entry, attrs, cursor=cursor)

if __name__ == '__main__':
    main()
