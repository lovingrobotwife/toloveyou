#! /home/orange/pyenv/bin/python -B

import sys
import random
import argparse
import subprocess

from toloveyou import *

def next_(entry, attrs):
    # ret/cap (see also: .bashrc) 
    with open('/tmp/capture.out', 'w') as f:
        f.write(f'{str(entry)}\n')

    returncode = call_scheduler(entry, attrs)
    
    # open entry
    subprocess.run(['open'], input=str(entry), text=True)
    
    if returncode == 3: # sys.exit(3)
        call_scheduler(entry, attrs, ask=True)

    print(json.dumps(attrs, indent=4))

@with_cursor
def main(cursor=None):
    parser = argparse.ArgumentParser()
    parser = argparse.ArgumentParser(prefix_chars='+')
    parser.add_argument('tags', nargs='*') 
    args = parser.parse_args()

    subset = None
        
    if random.random() < 0.33:  # about 1 in 3 chance
        subset = outstanding_fsrs_priority_sort(cursor=cursor)

    if not subset:
        subset = outstanding_priority_sort(cursor=cursor)

    if random.random() < 0.33:  # 1 in x chance
        random.shuffle(subset)

    for entry, attrs in parse(subset, cursor=cursor):
        tags = attrs.get('tags', []) # lazy tag filtering
                                     # TODO make not lazy
        
        exclude_tags = {tag[1:] for tag in args.tags if tag.startswith('-')}
        include_tags = {tag for tag in args.tags if not tag.startswith('-')}
    
        if any(tag in tags for tag in exclude_tags):
            continue
        if not include_tags.issubset(tags):
            continue

        next_(entry, attrs)
        break

if __name__ == '__main__':
    main()
